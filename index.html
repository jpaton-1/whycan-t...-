<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Garden AR Installation</title>
    
    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- GLTF loader for 3D models -->
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
        .arjs-loader {
            position: fixed;
            z-index: 999;
            overflow: show;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .arjs-loader div {
            text-align: center;
            color: white;
            max-width: 80%;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        #messageForm {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        
        #messageForm h3 {
            margin-top: 0;
            text-align: center;
            color: #4a7c59;
        }
        
        #messageForm input, #messageForm button {
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        
        #messageForm button {
            background: #4a7c59;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .toggle-form {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #4a7c59;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            z-index: 1000;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
        }
        
        #debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-family: monospace;
            padding: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
    </style>
    
    <script>
        // Register custom cursive text component using SVG
        AFRAME.registerComponent('cursive-text', {
            schema: {
                text: {type: 'string', default: 'Cursive Text'},
                color: {type: 'color', default: '#ffffff'},
                width: {type: 'number', default: 4},
                height: {type: 'number', default: 2}
            },
            
            init: function() {
                this.createCursiveText();
            },
            
            update: function() {
                this.createCursiveText();
            },
            
            createCursiveText: function() {
                // Clear previous content
                while (this.el.firstChild) {
                    this.el.removeChild(this.el.firstChild);
                }
                
                // Create SVG text image with cursive font
                const text = this.data.text;
                const width = this.data.width;
                const height = this.data.height;
                
                // Create SVG for the text
                const svgData = `
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${width * 100} ${height * 100}">
                    <style>
                        @import url('https://fonts.googleapis.com/css2?family=Gwendolyn:wght@700&display=swap');
                        .text {
                            font-family: 'Gwendolyn', cursive;
                            font-size: 60px;
                            font-weight: 700;
                            fill: ${this.data.color};
                            text-anchor: middle;
                            dominant-baseline: middle;
                        }
                    </style>
                    <text x="${width * 50}" y="${height * 40}" class="text">${text}</text>
                </svg>`;
                
                // Create blob URL from SVG
                const svgBlob = new Blob([svgData], {type: 'image/svg+xml'});
                const svgUrl = URL.createObjectURL(svgBlob);
                
                // Multiple planes for 3D effect
                const createLayer = (zPos, opacity, color) => {
                    const layer = document.createElement('a-plane');
                    layer.setAttribute('width', width);
                    layer.setAttribute('height', height);
                    layer.setAttribute('position', `0 0 ${zPos}`);
                    layer.setAttribute('material', {
                        src: svgUrl,
                        transparent: true,
                        opacity: opacity,
                        color: color
                    });
                    return layer;
                };
                
                // Create main text plane
                const mainLayer = createLayer(0, 1.0, '#ffffff');
                this.el.appendChild(mainLayer);
                
                // Create shadow layers for 3D effect
                this.el.appendChild(createLayer(-0.01, 0.7, '#a5d6a7'));
                this.el.appendChild(createLayer(-0.02, 0.5, '#4a7c59'));
                
                // Add a subtle floating animation
                this.el.setAttribute('animation', {
                    property: 'position',
                    dur: 8000,
                    dir: 'alternate',
                    easing: 'easeInOutSine',
                    loop: true,
                    from: '0 0 0',
                    to: '0 0.08 0'
                });
            }
        });
        
        // Flower model placer component
        AFRAME.registerComponent('flower-garden', {
            schema: {
                flowerCount: {type: 'number', default: 15},
                radius: {type: 'number', default: 3}
            },
            
            init: function() {
                this.placeFlowers();
            },
            
            placeFlowers: function() {
                // Flower model URLs - using free 3D models
                const flowerModels = [
                    'https://cdn.glitch.global/86ab404f-859d-409b-9df6-cbfdf954e5a7/sunflower.glb',
                    'https://cdn.glitch.global/86ab404f-859d-409b-9df6-cbfdf954e5a7/tulip.glb',
                    'https://cdn.glitch.global/86ab404f-859d-409b-9df6-cbfdf954e5a7/daisy.glb'
                ];
                
                // Place flowers in a circular pattern on the ground
                for (let i = 0; i < this.data.flowerCount; i++) {
                    // Calculate position in a circle with some randomness
                    const angle = (i / this.data.flowerCount) * Math.PI * 2;
                    const randomRadius = this.data.radius * (0.5 + Math.random() * 0.5);
                    const x = Math.cos(angle) * randomRadius;
                    const z = Math.sin(angle) * randomRadius;
                    
                    // Randomize model selection
                    const modelIndex = Math.floor(Math.random() * flowerModels.length);
                    const modelUrl = flowerModels[modelIndex];
                    
                    // Create flower entity
                    const flower = document.createElement('a-entity');
                    flower.setAttribute('gltf-model', modelUrl);
                    flower.setAttribute('position', {x: x, y: -1.5, z: z});
                    flower.setAttribute('scale', {
                        x: 0.5 + Math.random() * 0.5,
                        y: 0.5 + Math.random() * 0.5,
                        z: 0.5 + Math.random() * 0.5
                    });
                    flower.setAttribute('rotation', {
                        x: 0, 
                        y: Math.random() * 360, 
                        z: 0
                    });
                    
                    // Add subtle animation
                    flower.setAttribute('animation', {
                        property: 'rotation',
                        dir: 'alternate',
                        dur: 8000 + Math.random() * 4000,
                        easing: 'easeInOutSine',
                        loop: true,
                        to: `0 ${360 + Math.random() * 30} 0`
                    });
                    
                    this.el.appendChild(flower);
                }
            }
        });
        
        // Message board system
        let messages = [];
        const MAX_MESSAGES = 5;
        
        function addMessage(name, text) {
            const messageBoard = document.getElementById('messageBoard');
            
            // Create message group
            const messageEntity = document.createElement('a-entity');
            messageEntity.setAttribute('class', 'message');
            
            // Create message background
            const background = document.createElement('a-box');
            background.setAttribute('width', 2);
            background.setAttribute('height', 0.25);
            background.setAttribute('depth', 0.02);
            background.setAttribute('color', '#ffffff');
            background.setAttribute('opacity', 0.8);
            background.setAttribute('position', {x: 0, y: 0, z: -0.01});
            background.setAttribute('material', 'shader: standard; roughness: 0.3; metalness: 0.2');
            messageEntity.appendChild(background);
            
            // Add name text
            const nameText = document.createElement('a-text');
            nameText.setAttribute('value', name + ":");
            nameText.setAttribute('color', '#4a7c59');
            nameText.setAttribute('width', 1.8);
            nameText.setAttribute('position', {x: -0.9, y: 0.05, z: 0.01});
            nameText.setAttribute('align', 'left');
            nameText.setAttribute('scale', {x: 0.3, y: 0.3, z: 0.3});
            messageEntity.appendChild(nameText);
            
            // Add message text
            const messageText = document.createElement('a-text');
            messageText.setAttribute('value', text);
            messageText.setAttribute('color', '#000000');
            messageText.setAttribute('width', 1.8);
            messageText.setAttribute('position', {x: -0.9, y: -0.05, z: 0.01});
            messageText.setAttribute('align', 'left');
            messageText.setAttribute('scale', {x: 0.3, y: 0.3, z: 0.3});
            messageEntity.appendChild(messageText);
            
            // Add animation for appearing
            messageEntity.setAttribute('animation', {
                property: 'scale',
                from: '0.1 0.1 0.1',
                to: '1 1 1',
                dur: 800,
                easing: 'easeOutElastic'
            });
            
            messageBoard.appendChild(messageEntity);
            messages.push(messageEntity);
            
            // Reposition all messages
            repositionMessages();
        }
        
        // Reposition all messages to prevent overlap
        function repositionMessages() {
            if (messages.length > MAX_MESSAGES) {
                const oldestMessage = messages.shift();
                if (oldestMessage.parentNode) {
                    oldestMessage.parentNode.removeChild(oldestMessage);
                }
            }
            
            messages.forEach((msg, index) => {
                const yPos = -0.3 * index;
                msg.setAttribute('position', {x: 0, y: yPos, z: 0});
            });
        }
        
        // Debug helper
        function showDebugInfo(text) {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML += text + '<br>';
        }
        
        // DOM loaded handler
        document.addEventListener('DOMContentLoaded', function() {
            const toggleFormButton = document.getElementById('toggleForm');
            const messageForm = document.getElementById('messageForm');
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            const submitButton = document.getElementById('submitMessage');
            const arjsLoader = document.querySelector('.arjs-loader');
            
            // Auto-request camera
            requestCameraPermission();
            
            function requestCameraPermission() {
                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(function(stream) {
                        console.log("Camera access granted");
                        
                        // Hide loader after delay
                        setTimeout(() => {
                            arjsLoader.style.display = 'none';
                        }, 3000);
                        
                        // Stop the test stream
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(function(error) {
                        console.error("Camera access error:", error);
                        alert("Camera access is required for this AR experience. Please reload and allow camera access.");
                    });
            }
            
            // Toggle form button
            toggleFormButton.addEventListener('click', function() {
                messageForm.style.display = messageForm.style.display === 'none' ? 'block' : 'none';
            });
            
            // Submit message
            submitButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const name = nameInput.value.trim();
                const message = messageInput.value.trim();
                
                if (name && message) {
                    addMessage(name, message);
                    
                    // Clear form and hide
                    messageInput.value = '';
                    messageForm.style.display = 'none';
                } else {
                    alert("Please enter your name and message!");
                }
            });
            
            // Add sample messages after a delay
            setTimeout(() => {
                addMessage("Amanda", "I love this idea! We need more green spaces.");
                addMessage("Carlos", "My grandmother would enjoy helping tend to this.");
            }, 6000);
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <!-- Debug information -->
    <div id="debug-info"></div>
    
    <div class="arjs-loader">
        <div>
            <h1>Community Garden AR</h1>
            <p>Loading... Please allow camera access when prompted.</p>
        </div>
    </div>
    
    <!-- Message Form -->
    <form id="messageForm">
        <h3>Share Your Thoughts</h3>
        <input type="text" id="nameInput" placeholder="Your Name" required>
        <input type="text" id="messageInput" placeholder="Your Message" required>
        <button type="button" id="submitMessage">Submit</button>
    </form>
    
    <!-- Toggle Form Button -->
    <button class="toggle-form" id="toggleForm">+</button>
    
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;'
        renderer="logarithmicDepthBuffer: true; precision: mediump; colorManagement: true;"
        loading-screen="enabled: false">
        
        <!-- Green semi-transparent background -->
        <a-plane 
            position="0 0 -6" 
            rotation="0 0 0" 
            width="12" 
            height="9" 
            color="#e8f5e9" 
            opacity="0.7"
            material="side: double">
        </a-plane>
        
        <!-- Cursive text entity -->
        <a-entity 
            position="0 0.5 -4" 
            scale="1 1 1"
            cursive-text="text: Why can't this be\na community garden?; color: #ffffff; width: 5; height: 2">
        </a-entity>
        
        <!-- 3D Flower Garden -->
        <a-entity 
            position="0 0 -4"
            flower-garden="flowerCount: 20; radius: 3">
        </a-entity>
        
        <!-- Message board positioned below everything -->
        <a-entity id="messageBoard" position="0 -1.8 -4"></a-entity>
        
        <!-- Camera and cursor -->
        <a-entity camera look-controls position="0 0 0">
            <a-entity cursor="fuse: false"
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: #4a7c59; shader: flat">
            </a-entity>
        </a-entity>
    </a-scene>
</body>
</html>
