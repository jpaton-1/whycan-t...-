<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flourish AR Installation</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <style>
        .arjs-loader {
            position: fixed;
            z-index: 999;
            overflow: show;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .arjs-loader div {
            text-align: center;
            color: white;
            max-width: 80%;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        #messageForm {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        
        #messageForm h3 {
            margin-top: 0;
            text-align: center;
            color: #472183;
        }
        
        #messageForm input, #messageForm button {
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        
        #messageForm button {
            background: #472183;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .toggle-form {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #472183;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            z-index: 1000;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
        }
    </style>
    
    <script>
        // Register flower component
        AFRAME.registerComponent('flower', {
            schema: {
                color: {type: 'color', default: '#ff8a8a'},
                size: {type: 'number', default: 0.3},
                position: {type: 'vec3'},
                rotation: {type: 'vec3'}
            },
            
            init: function() {
                const data = this.data;
                const el = this.el;
                
                // Create flower center
                const center = document.createElement('a-sphere');
                center.setAttribute('color', '#f3e661');
                center.setAttribute('radius', data.size * 0.15);
                center.setAttribute('position', '0 0 0');
                el.appendChild(center);
                
                // Create petals
                const petalCount = 8;
                for (let i = 0; i < petalCount; i++) {
                    const angle = (i / petalCount) * Math.PI * 2;
                    const x = Math.cos(angle) * data.size * 0.4;
                    const y = Math.sin(angle) * data.size * 0.4;
                    
                    const petal = document.createElement('a-ellipsoid');
                    petal.setAttribute('scale', {
                        x: data.size * 0.3,
                        y: data.size * 0.4,
                        z: data.size * 0.1
                    });
                    petal.setAttribute('position', {x, y, z: 0});
                    petal.setAttribute('rotation', {
                        x: 0, 
                        y: 0, 
                        z: (angle * 180 / Math.PI)
                    });
                    petal.setAttribute('color', data.color);
                    petal.setAttribute('material', 'roughness: 0.8; metalness: 0.2');
                    
                    el.appendChild(petal);
                }
                
                // Position and rotate the entire flower
                if (data.position) {
                    el.setAttribute('position', data.position);
                }
                if (data.rotation) {
                    el.setAttribute('rotation', data.rotation);
                }
                
                // Add subtle animation
                el.setAttribute('animation', {
                    property: 'rotation',
                    dur: 8000 + Math.random() * 4000,
                    easing: 'easeInOutSine',
                    loop: true,
                    to: `${Math.random() * 10 - 5} ${Math.random() * 10 - 5} ${Math.random() * 10 - 5}`
                });
            }
        });
        
        // Register leaf component
        AFRAME.registerComponent('leaf', {
            schema: {
                color: {type: 'color', default: '#8b65e4'},
                size: {type: 'number', default: 0.3},
                position: {type: 'vec3'},
                rotation: {type: 'vec3'}
            },
            
            init: function() {
                const data = this.data;
                const el = this.el;
                
                // Create leaf shape
                const leaf = document.createElement('a-entity');
                leaf.setAttribute('geometry', {
                    primitive: 'plane',
                    width: data.size,
                    height: data.size * 2
                });
                
                // Apply material with leaf texture via SVG path
                const svgData = `
                    <svg viewBox="0 0 100 200" xmlns="http://www.w3.org/2000/svg">
                        <path d="M50,0 C100,50 100,150 50,200 C0,150 0,50 50,0 Z" fill="${data.color}" />
                        <path d="M50,10 L50,190" stroke="#000" stroke-width="1" stroke-opacity="0.2" />
                    </svg>`;
                
                const svgBlob = new Blob([svgData], {type: 'image/svg+xml'});
                const svgUrl = URL.createObjectURL(svgBlob);
                
                leaf.setAttribute('material', {
                    src: svgUrl,
                    transparent: true,
                    alphaTest: 0.5,
                    roughness: 0.7,
                    metalness: 0.2
                });
                
                el.appendChild(leaf);
                
                // Position and rotate
                if (data.position) {
                    el.setAttribute('position', data.position);
                }
                if (data.rotation) {
                    el.setAttribute('rotation', data.rotation);
                }
                
                // Add subtle animation
                el.setAttribute('animation', {
                    property: 'rotation',
                    dur: 10000 + Math.random() * 5000,
                    easing: 'easeInOutSine',
                    loop: true,
                    to: `${data.rotation.x + Math.random() * 10 - 5} ${data.rotation.y + Math.random() * 10 - 5} ${data.rotation.z + Math.random() * 10 - 5}`
                });
            }
        });
        
        // Flourish text component - creates stylized 3D text
        AFRAME.registerComponent('flourish-text', {
            init: function() {
                const el = this.el;
                
                // Create 3D text parts for stylized look
                const createTextPart = (yOffset, zOffset, color, opacity) => {
                    const text = document.createElement('a-text');
                    text.setAttribute('value', 'Flourish');
                    text.setAttribute('color', color);
                    text.setAttribute('opacity', opacity);
                    text.setAttribute('position', `0 ${yOffset} ${zOffset}`);
                    text.setAttribute('align', 'center');
                    text.setAttribute('width', 8);
                    text.setAttribute('font', 'https://cdn.aframe.io/fonts/Aileron-Semibold.fnt');
                    return text;
                };
                
                // Main text (white)
                const mainText = createTextPart(0, 0, '#ffffff', 1.0);
                mainText.setAttribute('scale', '1.2 1.2 1.2');
                el.appendChild(mainText);
                
                // Shadow/outline (adds depth)
                const shadow1 = createTextPart(0, -0.01, '#ff8fab', 0.7);
                shadow1.setAttribute('scale', '1.22 1.22 1.22');
                el.appendChild(shadow1);
                
                const shadow2 = createTextPart(0, -0.02, '#472183', 0.5);
                shadow2.setAttribute('scale', '1.24 1.24 1.24');
                el.appendChild(shadow2);
                
                // Add subtle floating animation
                el.setAttribute('animation', {
                    property: 'position',
                    dur: 6000,
                    dir: 'alternate',
                    easing: 'easeInOutSine',
                    loop: true,
                    from: '0 0 0',
                    to: '0 0.05 0'
                });
            }
        });
        
        // Message board system
        let messages = [];
        const MAX_MESSAGES = 5;
        
        function addMessage(name, text) {
            const messageBoard = document.getElementById('messageBoard');
            
            // Create message group
            const messageEntity = document.createElement('a-entity');
            messageEntity.setAttribute('class', 'message');
            
            // Create message background with curved shape
            const background = document.createElement('a-box');
            background.setAttribute('width', 2);
            background.setAttribute('height', 0.25);
            background.setAttribute('depth', 0.02);
            background.setAttribute('radius', 0.1);
            background.setAttribute('color', '#ffffff');
            background.setAttribute('opacity', 0.8);
            background.setAttribute('position', {x: 0, y: 0, z: -0.01});
            background.setAttribute('material', 'shader: standard; roughness: 0.3; metalness: 0.2');
            messageEntity.appendChild(background);
            
            // Add name text
            const nameText = document.createElement('a-text');
            nameText.setAttribute('value', name + ":");
            nameText.setAttribute('color', '#472183');
            nameText.setAttribute('width', 1.8);
            nameText.setAttribute('position', {x: -0.9, y: 0.05, z: 0.01});
            nameText.setAttribute('align', 'left');
            nameText.setAttribute('scale', {x: 0.3, y: 0.3, z: 0.3});
            messageEntity.appendChild(nameText);
            
            // Add message text
            const messageText = document.createElement('a-text');
            messageText.setAttribute('value', text);
            messageText.setAttribute('color', '#000000');
            messageText.setAttribute('width', 1.8);
            messageText.setAttribute('position', {x: -0.9, y: -0.05, z: 0.01});
            messageText.setAttribute('align', 'left');
            messageText.setAttribute('scale', {x: 0.3, y: 0.3, z: 0.3});
            messageEntity.appendChild(messageText);
            
            // Add animation for appearing
            messageEntity.setAttribute('animation', {
                property: 'scale',
                from: '0.1 0.1 0.1',
                to: '1 1 1',
                dur: 800,
                easing: 'easeOutElastic'
            });
            
            messageBoard.appendChild(messageEntity);
            messages.push(messageEntity);
            
            // Reposition all messages
            repositionMessages();
        }
        
        // Reposition all messages to avoid overlap
        function repositionMessages() {
            if (messages.length > MAX_MESSAGES) {
                const oldestMessage = messages.shift();
                if (oldestMessage.parentNode) {
                    oldestMessage.parentNode.removeChild(oldestMessage);
                }
            }
            
            messages.forEach((msg, index) => {
                const yPos = -0.3 * index;
                msg.setAttribute('position', {x: 0, y: yPos, z: 0});
            });
        }
        
        // DOM loaded handler
        document.addEventListener('DOMContentLoaded', function() {
            const toggleFormButton = document.getElementById('toggleForm');
            const messageForm = document.getElementById('messageForm');
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            const submitButton = document.getElementById('submitMessage');
            const arjsLoader = document.querySelector('.arjs-loader');
            
            // Auto-request camera
            requestCameraPermission();
            
            function requestCameraPermission() {
                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(function(stream) {
                        console.log("Camera access granted");
                        
                        // Hide loader after delay
                        setTimeout(() => {
                            arjsLoader.style.display = 'none';
                        }, 3000);
                        
                        // Stop the test stream
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(function(error) {
                        console.error("Camera access error:", error);
                        alert("Camera access is required for this AR experience. Please reload and allow camera access.");
                    });
            }
            
            // Toggle form button
            toggleFormButton.addEventListener('click', function() {
                messageForm.style.display = messageForm.style.display === 'none' ? 'block' : 'none';
            });
            
            // Submit message
            submitButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const name = nameInput.value.trim();
                const message = messageInput.value.trim();
                
                if (name && message) {
                    addMessage(name, message);
                    
                    // Clear form and hide
                    messageInput.value = '';
                    messageForm.style.display = 'none';
                } else {
                    alert("Please enter your name and message!");
                }
            });
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <div class="arjs-loader">
        <div>
            <h1>Flourish AR Installation</h1>
            <p>Loading... Please allow camera access when prompted.</p>
        </div>
    </div>
    
    <!-- Message Form -->
    <form id="messageForm">
        <h3>Share Your Thoughts</h3>
        <input type="text" id="nameInput" placeholder="Your Name" required>
        <input type="text" id="messageInput" placeholder="Your Message" required>
        <button type="button" id="submitMessage">Submit</button>
    </form>
    
    <!-- Toggle Form Button -->
    <button class="toggle-form" id="toggleForm">+</button>
    
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;'
        renderer="logarithmicDepthBuffer: true; precision: mediump; colorManagement: true;"
        loading-screen="enabled: false">
        
        <!-- Purple background -->
        <a-plane 
            position="0 0 -6" 
            rotation="0 0 0" 
            width="12" 
            height="9" 
            color="#2e1a47" 
            opacity="0.95"
            material="side: double">
        </a-plane>
        
        <!-- Flourish Text -->
        <a-entity 
            position="0 0.5 -4" 
            scale="1.5 1.5 1.5"
            flourish-text>
        </a-entity>
        
        <!-- Flowers and decorative elements -->
        <a-entity position="0 0 -4">
            <!-- Pink/Coral flowers -->
            <a-entity flower="color: #ff8a8a; size: 0.7; position: -2.2 1.2 0; rotation: 0 0 20"></a-entity>
            <a-entity flower="color: #ff8a8a; size: 0.6; position: 1.8 1.0 0.1; rotation: 0 0 -15"></a-entity>
            <a-entity flower="color: #ff8a8a; size: 0.5; position: -1.2 -1.0 0.2; rotation: 0 0 30"></a-entity>
            
            <!-- Blue/Purple flowers -->
            <a-entity flower="color: #a19bff; size: 0.65; position: 1.4 -0.8 0.1; rotation: 0 0 10"></a-entity>
            <a-entity flower="color: #a19bff; size: 0.7; position: -0.4 1.4 0.2; rotation: 0 0 -25"></a-entity>
            
            <!-- Purple leaves -->
            <a-entity leaf="color: #8b65e4; size: 0.6; position: -1.8 0.5 -0.1; rotation: 0 0 45"></a-entity>
            <a-entity leaf="color: #8b65e4; size: 0.5; position: 2.1 0.3 -0.1; rotation: 0 0 -60"></a-entity>
            <a-entity leaf="color: #8b65e4; size: 0.55; position: 1.0 1.2 -0.1; rotation: 0 0 30"></a-entity>
            <a-entity leaf="color: #8b65e4; size: 0.4; position: -0.8 -0.8 -0.1; rotation: 0 0 -40"></a-entity>
            <a-entity leaf="color: #8b65e4; size: 0.5; position: 0 -1.2 -0.1; rotation: 0 0 10"></a-entity>
            
            <!-- Yellow accent dots -->
            <a-sphere color="#f3e661" radius="0.12" position="-1.8 0.8 0.3" opacity="0.9"></a-sphere>
            <a-sphere color="#f3e661" radius="0.1" position="1.6 0.6 0.3" opacity="0.9"></a-sphere>
            <a-sphere color="#f3e661" radius="0.11" position="0.5 -1.0 0.3" opacity="0.9"></a-sphere>
            
            <!-- Pink small circles -->
            <a-ring color="#ff8fab" radius-inner="0.08" radius-outer="0.12" position="-1.2 0.6 0.2" opacity="0.8"></a-ring>
            <a-ring color="#ff8fab" radius-inner="0.06" radius-outer="0.09" position="1.0 -0.5 0.2" opacity="0.8"></a-ring>
            <a-ring color="#ff8fab" radius-inner="0.05" radius-outer="0.08" position="2.2 0.9 0.2" opacity="0.8"></a-ring>
        </a-entity>
        
        <!-- Message board positioned below the text -->
        <a-entity id="messageBoard" position="0 -1.2 -4"></a-entity>
        
        <!-- Camera and cursor -->
        <a-entity camera look-controls position="0 0 0">
            <a-entity cursor="fuse: false"
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: white; shader: flat">
            </a-entity>
        </a-entity>
    </a-scene>
</body>
</html>
