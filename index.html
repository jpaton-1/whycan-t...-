<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Text Installation with Message Board</title>
    
    <!-- Load A-Frame first -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    
    <!-- Add debug output -->
    <script>
        console.log("Starting application...");
        
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.message, event.filename, event.lineno);
        });
    </script>
    
    <!-- Load AR.js after A-Frame -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- 3D Text component -->
    <script>
        AFRAME.registerComponent('three-d-text', {
            schema: {
                value: {type: 'string', default: ''},
                color: {type: 'color', default: '#ffffff'},
                depth: {type: 'number', default: 0.1},
                align: {type: 'string', default: 'center'},
                width: {type: 'number', default: 5},
                height: {type: 'number', default: 1.5}
            },
            
            init: function() {
                this.createText();
            },
            
            update: function() {
                this.createText();
            },
            
            createText: function() {
                // Clear any existing content
                while (this.el.firstChild) {
                    this.el.removeChild(this.el.firstChild);
                }
                
                // Create main background
                const background = document.createElement('a-plane');
                background.setAttribute('width', this.data.width);
                background.setAttribute('height', this.data.height);
                background.setAttribute('color', '#236969');
                background.setAttribute('opacity', '0.8');
                background.setAttribute('position', {x: 0, y: 0, z: -0.05});
                this.el.appendChild(background);
                
                // Split text into individual characters for 3D effect
                const text = this.data.value;
                const letterSpacing = 0.15;
                const startX = -(text.length * letterSpacing) / 2;
                
                // Create each character with depth
                for (let i = 0; i < text.length; i++) {
                    if (text[i] === ' ') continue;
                    
                    const char = text[i];
                    const posX = startX + i * letterSpacing;
                    
                    // Front letter
                    const frontLetter = document.createElement('a-text');
                    frontLetter.setAttribute('value', char);
                    frontLetter.setAttribute('color', this.data.color);
                    frontLetter.setAttribute('align', 'center');
                    frontLetter.setAttribute('width', 0.8);
                    frontLetter.setAttribute('position', {x: posX, y: 0, z: 0.01});
                    this.el.appendChild(frontLetter);
                    
                    // Side/extrusion effect - multiple layers
                    for (let depth = 1; depth <= 5; depth++) {
                        const depthText = document.createElement('a-text');
                        depthText.setAttribute('value', char);
                        depthText.setAttribute('color', '#1a4d4d'); // Darker shade for sides
                        depthText.setAttribute('align', 'center');
                        depthText.setAttribute('width', 0.8);
                        depthText.setAttribute('position', {
                            x: posX, 
                            y: 0, 
                            z: 0.01 - (depth * this.data.depth / 5)
                        });
                        this.el.appendChild(depthText);
                    }
                }
                
                // Add lighting to enhance 3D effect
                const light = document.createElement('a-light');
                light.setAttribute('type', 'directional');
                light.setAttribute('intensity', 0.8);
                light.setAttribute('position', {x: 1, y: 1, z: 1});
                this.el.appendChild(light);
            }
        });
    </script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <style>
        .arjs-loader {
            position: fixed;
            z-index: 999;
            overflow: show;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .arjs-loader div {
            text-align: center;
            color: white;
            max-width: 80%;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        #camera-permission-error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 10px 0;
            z-index: 1001;
            display: none;
        }
        
        #camera-retry-button {
            background: white;
            color: black;
            border: none;
            padding: 8px 16px;
            margin-top: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        #messageForm {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        
        #messageForm h3 {
            margin-top: 0;
            text-align: center;
            color: #236969;
        }
        
        #messageForm input, #messageForm button {
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        
        #messageForm button {
            background: #236969;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .toggle-form {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #236969;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            z-index: 1000;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
        }
        
        #debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-family: monospace;
            padding: 5px;
            font-size: 12px;
            z-index: 1000;
            max-width: 80%;
            display: none;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">
    <!-- Debug information -->
    <div id="debug-info"></div>
    
    <!-- Camera permission error message -->
    <div id="camera-permission-error">
        <p>Camera access denied. Please enable camera access in your browser settings to use this AR experience.</p>
        <button id="camera-retry-button">Try Again</button>
    </div>
    
    <div class="arjs-loader">
        <div>
            <h1>AR Art Installation</h1>
            <p>Please allow camera and location access when prompted.</p>
            <p>If nothing happens, please check your browser permissions.</p>
        </div>
    </div>
    
    <!-- Message Form -->
    <form id="messageForm">
        <h3>Share Your Thoughts</h3>
        <input type="text" id="nameInput" placeholder="Your Name" required>
        <input type="text" id="messageInput" placeholder="Your Message" required>
        <button type="button" id="submitMessage">Submit</button>
    </form>
    
    <!-- Toggle Form Button -->
    <button class="toggle-form" id="toggleForm">+</button>
    
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;'
        renderer="logarithmicDepthBuffer: true; precision: mediump;"
        loading-screen="enabled: false"
        debug>
        
        <!-- Main text with 3D effect -->
        <a-entity 
            id="textArtifact"
            position="0 0.8 -2"
            rotation="0 0 0"
            three-d-text="value: WHAT BRINGS YOU JOY?; color: #ffffff; depth: 0.05; width: 2; height: 0.7">
        </a-entity>
        
        <!-- Message board positioned well below the text to avoid overlap -->
        <a-entity id="messageBoard" position="0 -0.5 -2"></a-entity>
        
        <!-- Camera with mouse/touch cursor -->
        <a-entity camera look-controls>
            <a-entity cursor="fuse: false"
                      position="0 0 -1"
                      geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
                      material="color: white; shader: flat">
            </a-entity>
        </a-entity>
    </a-scene>
    
    <script>
        console.log("Initializing script...");
        
        // Firebase configuration
        // IMPORTANT: Replace with your own Firebase config!
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.appspot.com",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        let fbInitialized = false;
        try {
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const messagesCollection = db.collection('messages');
            fbInitialized = true;
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showDebugInfo("Firebase error: " + error.message);
        }
        
        // Add message component
        let messageY = 0;
        let messages = [];
        const MAX_MESSAGES = 5; // Limit visible messages to avoid overcrowding
        
        function addMessage(name, text) {
            const messageBoard = document.getElementById('messageBoard');
            
            // Create message group
            const messageEntity = document.createElement('a-entity');
            messageEntity.setAttribute('position', {x: 0, y: messageY, z: 0});
            messageEntity.setAttribute('class', 'message');
            
            // Create message background with slight 3D effect
            const background = document.createElement('a-box');
            background.setAttribute('width', 2);
            background.setAttribute('height', 0.25);
            background.setAttribute('depth', 0.03);
            background.setAttribute('color', '#ffffff');
            background.setAttribute('opacity', 0.8);
            background.setAttribute('position', {x: 0, y: 0, z: -0.015});
            background.setAttribute('material', 'shader: standard; roughness: 0.3; metalness: 0.2');
            messageEntity.appendChild(background);
            
            // Add name text
            const nameText = document.createElement('a-text');
            nameText.setAttribute('value', name + ": ");
            nameText.setAttribute('color', '#236969');
            nameText.setAttribute('width', 1.8);
            nameText.setAttribute('position', {x: -0.9, y: 0.05, z: 0.01});
            nameText.setAttribute('align', 'left');
            nameText.setAttribute('scale', {x: 0.3, y: 0.3, z: 0.3});
            messageEntity.appendChild(nameText);
            
            // Add message text
            const messageText = document.createElement('a-text');
            messageText.setAttribute('value', text);
            messageText.setAttribute('color', '#000000');
            messageText.setAttribute('width', 1.8);
            messageText.setAttribute('position', {x: -0.9, y: -0.05, z: 0.01});
            messageText.setAttribute('align', 'left');
            messageText.setAttribute('scale', {x: 0.3, y: 0.3, z: 0.3});
            messageEntity.appendChild(messageText);
            
            // Add animation for appearing
            messageEntity.setAttribute('animation', {
                property: 'scale',
                from: '0.1 0.1 0.1',
                to: '1 1 1',
                dur: 800,
                easing: 'easeOutElastic'
            });
            
            messageBoard.appendChild(messageEntity);
            messages.push(messageEntity);
            
            // Reposition all messages
            repositionMessages();
        }
        
        // Reposition all messages to prevent overlap
        function repositionMessages() {
            // Limit number of visible messages
            if (messages.length > MAX_MESSAGES) {
                // Remove oldest message
                const oldestMessage = messages.shift();
                if (oldestMessage.parentNode) {
                    oldestMessage.parentNode.removeChild(oldestMessage);
                }
            }
            
            // Reposition remaining messages
            messages.forEach((msg, index) => {
                // Position each message below the previous one
                const yPos = -0.3 * index;
                msg.setAttribute('position', {x: 0, y: yPos, z: 0});
            });
        }
        
        // Debug helper
        function showDebugInfo(text) {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML += text + '<br>';
        }
        
        // DOM loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded");
            showDebugInfo("DOM loaded");
            
            const toggleFormButton = document.getElementById('toggleForm');
            const messageForm = document.getElementById('messageForm');
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            const submitButton = document.getElementById('submitMessage');
            const arjsLoader = document.querySelector('.arjs-loader');
            
            // Request camera permission
            requestCameraPermission();
            
            function requestCameraPermission() {
                console.log("Requesting camera permission...");
                showDebugInfo("Requesting camera...");
                
                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(function(stream) {
                        console.log("Camera access granted");
                        showDebugInfo("Camera OK");
                        
                        // Hide loader after delay
                        setTimeout(() => {
                            arjsLoader.style.display = 'none';
                        }, 3000);
                        
                        // Stop our test stream as AR.js will handle the camera
                        const tracks = stream.getTracks();
                        tracks.forEach(track => track.stop());
                    })
                    .catch(function(error) {
                        console.error("Camera access error:", error);
                        showDebugInfo("Camera error: " + error.message);
                        
                        // Show error message
                        const errorDiv = document.getElementById('camera-permission-error');
                        errorDiv.style.display = 'block';
                        arjsLoader.style.display = 'none';
                    });
            }
            
            // Camera retry button
            const cameraRetryButton = document.getElementById('camera-retry-button');
            if (cameraRetryButton) {
                cameraRetryButton.addEventListener('click', function() {
                    const errorDiv = document.getElementById('camera-permission-error');
                    errorDiv.style.display = 'none';
                    requestCameraPermission();
                });
            }
            
            // Toggle form button
            toggleFormButton.addEventListener('click', function() {
                messageForm.style.display = messageForm.style.display === 'none' ? 'block' : 'none';
            });
            
            // Submit message
            submitButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const name = nameInput.value.trim();
                const message = messageInput.value.trim();
                
                if (name && message) {
                    // Add message to display immediately
                    addMessage(name, message);
                    
                    // Add to Firebase if initialized
                    if (fbInitialized) {
                        messagesCollection.add({
                            name: name,
                            message: message,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        })
                        .then(() => {
                            console.log("Message saved to Firebase");
                        })
                        .catch((error) => {
                            console.error("Error adding message:", error);
                            showDebugInfo("Save error: " + error.message);
                        });
                    }
                    
                    // Clear form and hide
                    messageInput.value = '';
                    messageForm.style.display = 'none';
                } else {
                    alert("Please enter your name and message!");
                }
            });
            
            // Add some test messages after delay
            setTimeout(() => {
                addMessage("Test User", "This is a test message!");
                addMessage("Another User", "Enjoying this AR installation!");
            }, 5000);
        });
        
        // Scene loaded event
        document.querySelector('a-scene').addEventListener('loaded', function () {
            console.log("A-Frame scene loaded");
            showDebugInfo("Scene loaded");
        });
    </script>
</body>
</html>
