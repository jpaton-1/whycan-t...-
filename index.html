<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Garden AR Installation</title>
    
    <!-- A-Frame and AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    
    <!-- GLTF loader for 3D models -->
    <script src="https://unpkg.com/aframe-extras@6.1.1/dist/aframe-extras.min.js"></script>
    
    <style>
        .arjs-loader {
            position: fixed;
            z-index: 999;
            overflow: show;
            margin: auto;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .arjs-loader div {
            text-align: center;
            color: white;
            max-width: 80%;
            font-family: Arial, Helvetica, sans-serif;
        }
        
        #messageForm {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }
        
        #messageForm h3 {
            margin-top: 0;
            text-align: center;
            color: #4a7c59;
        }
        
        #messageForm input, #messageForm button {
            margin: 5px 0;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            width: 100%;
            box-sizing: border-box;
        }
        
        #messageForm button {
            background: #4a7c59;
            color: white;
            border: none;
            cursor: pointer;
        }
        
        .toggle-form {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #4a7c59;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 50%;
            z-index: 1000;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
        }
        
        #debug-info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            font-family: monospace;
            padding: 5px;
            font-size: 12px;
            z-index: 1000;
            display: none;
        }
    </style>
    
    <script>
        // Register custom extruded text component
        AFRAME.registerComponent('extruded-text', {
            schema: {
                text: {type: 'string', default: 'Text'},
                depth: {type: 'number', default: 0.15},
                size: {type: 'number', default: 1}
            },
            
            init: function() {
                this.createExtrudedText();
            },
            
            update: function() {
                this.createExtrudedText();
            },
            
            createExtrudedText: function() {
                // Clear previous content
                while (this.el.firstChild) {
                    this.el.removeChild(this.el.firstChild);
                }
                
                // Main text entity - using A-Frame's text geometry which supports extrusion
                const textEntity = document.createElement('a-entity');
                
                // Create the text with extrusion
                textEntity.setAttribute('text-geometry', {
                    value: this.data.text,
                    font: '#optimerFont',
                    size: this.data.size,
                    height: this.data.depth,
                    bevelEnabled: true,
                    bevelSize: 0.02,
                    bevelThickness: 0.02,
                    curveSegments: 12
                });
                
                // Apply white material with slight shine
                textEntity.setAttribute('material', {
                    color: '#ffffff',
                    roughness: 0.2,
                    metalness: 0.3
                });
                
                this.el.appendChild(textEntity);
                
                // Add subtle floating animation
                this.el.setAttribute('animation', {
                    property: 'position',
                    dur: 8000,
                    dir: 'alternate',
                    easing: 'easeInOutSine',
                    loop: true,
                    from: '0 0 0',
                    to: '0 0.08 0'
                });
            }
        });
        
        // Flower model placer component
        AFRAME.registerComponent('flower-garden', {
            schema: {
                flowerCount: {type: 'number', default: 15},
                radius: {type: 'number', default: 3}
            },
            
            init: function() {
                this.placeFlowers();
            },
            
            placeFlowers: function() {
                // Local flower model files from repository
                const flowerModels = [
                    '6 Orchid.glb',
                    '7 Poppy.glb',
                    '8 Iris.glb',
                    '13 Marigold.glb',
                    '16 Lavender.glb',
                    '17 Hibiscus.glb',
                    '20 Violet.glb',
                    '24 Cosmos.glb',
                    '25 Snapdragon.glb',
                    '26 Morning Glory.glb',
                    '27 Anemone.glb',
                    '30 Primrose.glb'
                ];
                
                // Place flowers in a circular pattern on the ground
                for (let i = 0; i < this.data.flowerCount; i++) {
                    // Calculate position in a circle with some randomness
                    const angle = (i / this.data.flowerCount) * Math.PI * 2;
                    const randomRadius = this.data.radius * (0.3 + Math.random() * 0.7);
                    const x = Math.cos(angle) * randomRadius;
                    const z = Math.sin(angle) * randomRadius;
                    
                    // Randomize model selection
                    const modelIndex = Math.floor(Math.random() * flowerModels.length);
                    const modelUrl = flowerModels[modelIndex];
                    
                    // Create flower entity
                    const flower = document.createElement('a-entity');
                    flower.setAttribute('gltf-model', modelUrl);
                    
                    // Position flower on ground level with slight variation
                    // Set y to -2.0 to place right on the ground
                    flower.setAttribute('position', {x: x, y: -2.0, z: z});
                    
                    // Random scale, but keep it proportional
                    const scale = 0.5 + Math.random() * 0.3;
                    flower.setAttribute('scale', {
                        x: scale,
                        y: scale,
                        z: scale
                    });
                    
                    flower.setAttribute('rotation', {
                        x: 0, 
                        y: Math.random() * 360, 
                        z: 0
                    });
                    
                    // Add spring-up animation
                    flower.setAttribute('animation', {
                        property: 'position',
                        from: `${x} -2.2 ${z}`,
                        to: `${x} -2.0 ${z}`,
                        dur: 3000 + Math.random() * 2000,
                        delay: Math.random() * 3000,
                        easing: 'easeOutElastic',
                        loop: false
                    });
                    
                    // Add subtle swaying animation
                    flower.setAttribute('animation__sway', {
                        property: 'rotation',
                        dir: 'alternate',
                        dur: 10000 + Math.random() * 5000,
                        easing: 'easeInOutSine',
                        loop: true,
                        from: `0 ${Math.random() * 360} 0`,
                        to: `${Math.random() * 5 - 2.5} ${Math.random() * 360 + 10} ${Math.random() * 5 - 2.5}`
                    });
                    
                    this.el.appendChild(flower);
                }
            }
        });
            }
        });
        
        // Message board system
        let messages = [];
        const MAX_MESSAGES = 5;
        
        function addMessage(name, text) {
            const messageBoard = document.getElementById('messageBoard');
            
            // Create message group
            const messageEntity = document.createElement('a-entity');
            messageEntity.setAttribute('class', 'message');
            
            // Create message background
            const background = document.createElement('a-box');
            background.setAttribute('width', 2);
            background.setAttribute('height', 0.25);
            background.setAttribute('depth', 0.02);
            background.setAttribute('color', '#ffffff');
            background.setAttribute('opacity', 0.8);
            background.setAttribute('position', {x: 0, y: 0, z: -0.01});
            background.setAttribute('material', 'shader: standard; roughness: 0.3; metalness: 0.2');
            messageEntity.appendChild(background);
            
            // Add name text
            const nameText = document.createElement('a-text');
            nameText.setAttribute('value', name + ":");
            nameText.setAttribute('color', '#4a7c59');
            nameText.setAttribute('width', 1.8);
            nameText.setAttribute('position', {x: -0.9, y: 0.05, z: 0.01});
            nameText.setAttribute('align', 'left');
            nameText.setAttribute('scale', {x: 0.3, y: 0.3, z: 0.3});
            messageEntity.appendChild(nameText);
            
            // Add message text
            const messageText = document.createElement('a-text');
            messageText.setAttribute('value', text);
            messageText.setAttribute('color', '#000000');
            messageText.setAttribute('width', 1.8);
            messageText.setAttribute('position', {x: -0.9, y: -0.05, z: 0.01});
            messageText.setAttribute('align', 'left');
            messageText.setAttribute('scale', {x: 0.3, y: 0.3, z: 0.3});
            messageEntity.appendChild(messageText);
            
            // Add animation for appearing
            messageEntity.setAttribute('animation', {
                property: 'scale',
                from: '0.1 0.1 0.1',
                to: '1 1 1',
                dur: 800,
                easing: 'easeOutElastic'
            });
            
            messageBoard.appendChild(messageEntity);
            messages.push(messageEntity);
            
            // Reposition all messages
            repositionMessages();
        }
        
        // Reposition all messages to prevent overlap
        function repositionMessages() {
            if (messages.length > MAX_MESSAGES) {
                const oldestMessage = messages.shift();
                if (oldestMessage.parentNode) {
                    oldestMessage.parentNode.removeChild(oldestMessage);
                }
            }
            
            messages.forEach((msg, index) => {
                const yPos = -0.3 * index;
                msg.setAttribute('position', {x: 0, y: yPos, z: 0});
            });
        }
        
        // Debug helper
        function showDebugInfo(text) {
            const debugDiv = document.getElementById('debug-info');
            debugDiv.style.display = 'block';
            debugDiv.innerHTML += text + '<br>';
        }
        
        // DOM loaded handler
        document.addEventListener('DOMContentLoaded', function() {
            const toggleFormButton = document.getElementById('toggleForm');
            const messageForm = document.getElementById('messageForm');
            const nameInput = document.getElementById('nameInput');
            const messageInput = document.getElementById('messageInput');
            const submitButton = document.getElementById('submitMessage');
            const arjsLoader = document.querySelector('.arjs-loader');
            
            // Auto-request camera
            requestCameraPermission();
            
            function requestCameraPermission() {
                navigator.mediaDevices.getUserMedia({ video: true, audio: false })
                    .then(function(stream) {
                        console.log("Camera access granted");
                        
                        // Hide loader after delay
                        setTimeout(() => {
                            arjsLoader.style.display = 'none';
                        }, 3000);
                        
                        // Stop the test stream
                        stream.getTracks().forEach(track => track.stop());
                    })
                    .catch(function(error) {
                        console.error("Camera access error:", error);
                        alert("Camera access is required for this AR experience. Please reload and allow camera access.");
                    });
            }
            
            // Toggle form button
            toggleFormButton.addEventListener('click', function() {
                messageForm.style.display = messageForm.style.display === 'none' ? 'block' : 'none';
            });
            
            // Submit message
            submitButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                const name = nameInput.value.trim();
                const message = messageInput.value.trim();
                
                if (name && message) {
                    addMessage(name, message);
                    
                    // Clear form and hide
                    messageInput.value = '';
                    messageForm.style.display = 'none';
                } else {
                    alert("Please enter your name and message!");
                }
            });
            
            // Add sample messages after a delay
            setTimeout(() => {
                addMessage("Amanda", "I love this idea! We need more green spaces.");
                addMessage("Carlos", "My grandmother would enjoy helping tend to this.");
            }, 6000);
        });
    </script>
</head>
<body style="margin: 0; overflow: hidden;">
    <!-- Debug information -->
    <div id="debug-info"></div>
    
    <div class="arjs-loader">
        <div>
            <h1>Community Garden AR</h1>
            <p>Loading... Please allow camera access when prompted.</p>
        </div>
    </div>
    
    <!-- Message Form -->
    <form id="messageForm">
        <h3>Share Your Thoughts</h3>
        <input type="text" id="nameInput" placeholder="Your Name" required>
        <input type="text" id="messageInput" placeholder="Your Message" required>
        <button type="button" id="submitMessage">Submit</button>
    </form>
    
    <!-- Toggle Form Button -->
    <button class="toggle-form" id="toggleForm">+</button>
    
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix;'
        renderer="logarithmicDepthBuffer: true; precision: mediump; colorManagement: true;"
        loading-screen="enabled: false">
        
        <!-- Extruded white text -->
        <a-entity 
            position="0 0 -4" 
            scale="0.8 0.8 0.8"
            extruded-text="text: Why can't this be a community garden?; depth: 0.1; size: 0.3">
        </a-entity>
        
        <!-- 3D Flower Garden -->
        <a-entity 
            position="0 0 -4"
            flower-garden="flowerCount: 30; radius: 3">
        </a-entity>
        
        <!-- Camera -->
        <a-entity camera look-controls position="0 0 0"></a-entity>
        
        <!-- Font for text geometry -->
        <a-assets>
            <a-asset-item id="optimerFont" src="https://cdn.aframe.io/fonts/Exo2Bold.typeface.json"></a-asset-item>
        </a-assets>
    </a-scene>
</body>
</html>
